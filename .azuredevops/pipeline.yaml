---
trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*

pr:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  System.Debug: true

stages:
  - stage: CI
    jobs:
      - template: templates/ci.yaml

  - stage: Private
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionTag: "-dev"
          extensionName: Argo CD CLI Installer (DEV)
          extensionVisibility: private

      - job: check
        dependsOn: publish
        timeoutInMinutes: 60
        variables:
          Extension.Version: $[ dependencies.publish.outputs['QueryVersion.Extension.Version'] ]
        steps:
          - checkout: none
          - bash: |
              echo "Check if the extension is published"
              echo "Extension version: $(Extension.Version)"
            displayName: "Check if the extension is published"

      - job: wait
        dependsOn: [publish, check]
        timeoutInMinutes: 60
        pool: server
        variables:
          Extension.Version: $[ dependencies.publish.outputs['QueryVersion.Extension.Version'] ]
        steps:
          - task: InvokeRESTAPI@1
            retryCountOnTaskFailure: 3
            inputs:
              connectionType: "connectedServiceName"
              serviceConnection: "https://dev.azure.com"
              method: "GET"
              urlSuffix: "/bonddim/_apis/distributedtask/tasks/bf9f5d10-e985-11ef-80f2-00155de5031d"
              waitForCompletion: "false"
              successCriteria: eq(jsonpath('.value[0].contributionVersion')[0], variables['Extension.Version'])
              headers: |
                {
                  "Authorization": "Bearer $(System.AccessToken)"
                }

  - stage: Public
    # condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionName: Argo CD CLI Installer
          extensionVisibility: public
