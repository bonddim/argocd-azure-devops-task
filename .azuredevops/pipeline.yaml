---
trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*

pr:
  - main

pool:
  vmImage: ubuntu-latest

stages:
  - stage: CI
    jobs:
      - template: templates/ci.yaml

  - stage: Private
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionTag: -dev
          extensionName: Argo CD CLI Installer (DEV)
          extensionVisibility: private
          taskNameSuffix: Dev

      - template: templates/wait.yaml
        parameters:
          orgServiceConnection: https://dev.azure.com
          taskName: ArgoCDInstallerDev

      - template: templates/e2e.yaml
        parameters:
          extensionVisibility: private

  - stage: Public
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionName: Argo CD CLI Installer
          extensionVisibility: public

      - template: templates/wait.yaml
        parameters:
          orgServiceConnection: https://dev.azure.com
          taskId: bf9f5d10-e985-11ef-80f2-00155de5031d

      - template: templates/e2e.yaml
        parameters:
          extensionVisibility: public

      - job: Release
        dependsOn: [publish, E2E]
        variables:
          version: $[ dependencies.publish.outputs['QueryVersion.Extension.Version'] ]
        steps:
          - checkout: none
          - task: GitHubRelease@1
            inputs:
              gitHubConnection: bonddim
              repositoryName: $(Build.Repository.Name)
              action: create
              target: $(Build.SourceVersion)
              tagSource: userSpecifiedTag
              tag: $(version)
              assets:
              changeLogCompareToRelease: lastFullRelease
              changeLogType: commitBased
