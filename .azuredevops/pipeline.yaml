---
trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*

pr:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  System.Debug: true

stages:
  - stage: CI
    jobs:
      - template: templates/ci.yaml

  - stage: Private
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionTag: -dev
          extensionName: Argo CD CLI Installer (DEV)
          extensionVisibility: private
          taskNameSuffix: Dev

      - template: templates/wait.yaml
        parameters:
          orgServiceConnection: https://dev.azure.com
          taskName: ArgoCDInstallerDev
          retryCount: 5

  - stage: E2E
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: E2E
        strategy:
          matrix:
            linux:
              imageName: ubuntu-latest
              version: latest
              options: --grpc-web
            mac:
              imageName: macOS-latest
              options: --grpc-web --insecure
              version: ""
            windows:
              imageName: windows-latest
              options: --plaintext
              version: v2.13.5
        pool:
          vmImage: $(imageName)
        steps:
          - checkout: none
          - task: ArgoCDInstallerDev@0
            inputs:
              version: $(version)
              options: $(options)

  - stage: Public
    # condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: templates/publish.yaml
        parameters:
          publisherId: bonddim
          extensionId: argocd-installer
          extensionName: Argo CD CLI Installer
          extensionVisibility: public
